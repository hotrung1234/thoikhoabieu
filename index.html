import React, { useState, useEffect, useCallback, useMemo } from 'react';
import ReactDOM from 'react-dom';

const DAYS_OF_WEEK = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];

function SubjectModal({ subject, onSave, onClose, isEditing }) {
    const [name, setName] = useState(subject?.name || '');
    const [time, setTime] = useState(subject?.time || '');
    const [note, setNote] = useState(subject?.note || '');

    const handleSave = () => {
        if (!name.trim() || !time.trim()) {
            alert('Vui lòng nhập tên môn học và thời gian');
            return;
        }
        onSave({ 
            id: subject?.id || Date.now(), 
            name, 
            time, 
            note 
        });
    };

    return (
        <div className="modal">
            <div className="modal-content">
                <h2>{isEditing ? 'Chỉnh Sửa Môn Học' : 'Thêm Môn Học'}</h2>
                <input 
                    type="text" 
                    placeholder="Tên môn học" 
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                />
                <input 
                    type="text" 
                    placeholder="Thời gian" 
                    value={time}
                    onChange={(e) => setTime(e.target.value)}
                />
                <input 
                    type="text" 
                    placeholder="Ghi chú" 
                    value={note}
                    onChange={(e) => setNote(e.target.value)}
                />
                <div className="modal-actions">
                    <button onClick={handleSave}>Lưu</button>
                    <button onClick={onClose}>Hủy</button>
                </div>
            </div>
        </div>
    );
}

function App() {
    const [subjects, setSubjects] = useState(() => {
        const savedSubjects = localStorage.getItem('subjects');
        return savedSubjects ? JSON.parse(savedSubjects) : [];
    });

    const [schedule, setSchedule] = useState(() => {
        const savedSchedule = localStorage.getItem('schedule');
        return savedSchedule ? JSON.parse(savedSchedule) : 
            DAYS_OF_WEEK.reduce((acc, day) => ({ ...acc, [day]: [] }), {});
    });

    const [modalSubject, setModalSubject] = useState(null);
    const [isModalOpen, setIsModalOpen] = useState(false);

    useEffect(() => {
        localStorage.setItem('subjects', JSON.stringify(subjects));
        localStorage.setItem('schedule', JSON.stringify(schedule));
    }, [subjects, schedule]);

    const addSubject = useCallback((newSubject) => {
        setSubjects(prev => [...prev, newSubject]);
        setSchedule(prev => ({
            ...prev,
            [DAYS_OF_WEEK[0]]: [...prev[DAYS_OF_WEEK[0]], newSubject]
        }));
        setIsModalOpen(false);
    }, []);

    const updateSubject = useCallback((updatedSubject) => {
        setSubjects(prev => 
            prev.map(s => s.id === updatedSubject.id ? updatedSubject : s)
        );
        
        setSchedule(prev => {
            const newSchedule = {...prev};
            for (let day in newSchedule) {
                newSchedule[day] = newSchedule[day].map(s => 
                    s.id === updatedSubject.id ? updatedSubject : s
                );
            }
            return newSchedule;
        });
        
        setIsModalOpen(false);
    }, []);

    const deleteSubject = useCallback((subjectId) => {
        setSubjects(prev => prev.filter(s => s.id !== subjectId));
        setSchedule(prev => {
            const newSchedule = {...prev};
            for (let day in newSchedule) {
                newSchedule[day] = newSchedule[day].filter(s => s.id !== subjectId);
            }
            return newSchedule;
        });
    }, []);

    const moveSubject = useCallback((subject, sourceDay, targetDay) => {
        setSchedule(prev => {
            const newSchedule = {...prev};
            newSchedule[sourceDay] = newSchedule[sourceDay].filter(s => s.id !== subject.id);
            newSchedule[targetDay] = [...newSchedule[targetDay], subject];
            return newSchedule;
        });
    }, []);

    const renderScheduleTable = useMemo(() => {
        return DAYS_OF_WEEK.map(day => (
            <td 
                key={day} 
                onDragOver={(e) => e.preventDefault()}
                onDrop={(e) => {
                    const subjectId = e.dataTransfer.getData('text/plain');
                    const subject = subjects.find(s => s.id.toString() === subjectId);
                    if (subject) {
                        const sourceDay = Object.keys(schedule).find(d => 
                            schedule[d].some(s => s.id.toString() === subjectId)
                        );
                        moveSubject(subject, sourceDay, day);
                    }
                }}
            >
                {schedule[day].map(subject => (
                    <div 
                        key={subject.id} 
                        className="subject-item"
                        draggable
                        onDragStart={(e) => {
                            e.dataTransfer.setData('text/plain', subject.id.toString());
                        }}
                        onClick={() => {
                            setModalSubject(subject);
                            setIsModalOpen(true);
                        }}
                    >
                        <span>{subject.name} - {subject.time}</span>
                        <button 
                            className="delete-btn"
                            onClick={(e) => {
                                e.stopPropagation();
                                deleteSubject(subject.id);
                            }}
                        >
                            ✖
                        </button>
                    </div>
                ))}
            </td>
        ));
    }, [schedule, subjects, deleteSubject, moveSubject]);

    return (
        <div className="app-container">
            <h1>Thời Khóa Biểu</h1>
            <button 
                className="add-subject-btn"
                onClick={() => {
                    setModalSubject(null);
                    setIsModalOpen(true);
                }}
            >
                Thêm Môn Học
            </button>

            <table className="schedule-table">
                <thead>
                    <tr>
                        {DAYS_OF_WEEK.map(day => (
                            <th key={day}>{day}</th>
                        ))}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {renderScheduleTable}
                    </tr>
                </tbody>
            </table>

            {isModalOpen && (
                <SubjectModal 
                    subject={modalSubject}
                    onSave={modalSubject ? updateSubject : addSubject}
                    onClose={() => setIsModalOpen(false)}
                    isEditing={!!modalSubject}
                />
            )}
        </div>
    );
}

function AppWrapper() {
    const [styles, setStyles] = useState('');

    useEffect(() => {
        const fetchStyles = async () => {
            const css = `
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f4f4f4;
                }
                .app-container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .schedule-table {
                    width: 100%;
                    border-collapse: collapse;
                }
                .schedule-table th, .schedule-table td {
                    border: 1px solid #ddd;
                    padding: 10px;
                    text-align: center;
                }
                .subject-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background-color: #e6f3ff;
                    margin: 5px 0;
                    padding: 10px;
                    border-radius: 5px;
                }
                .delete-btn {
                    background-color: #ff4d4d;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                }
                .modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                .modal-content {
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    width: 90%;
                    max-width: 500px;
                }
                .modal-content input {
                    width: 100%;
                    margin: 10px 0;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                }
                .modal-actions {
                    display: flex;
                    justify-content: space-between;
                }
                .modal-actions button {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                }
                @media (max-width: 768px) {
                    .schedule-table {
                        display: block;
                        overflow-x: auto;
                    }
                }
            `;
            setStyles(css);
        };
        fetchStyles();
    }, []);

    return (
        <>
            <style>{styles}</style>
            <App />
        </>
    );
}

ReactDOM.render(<AppWrapper />, document.getElementById('root'));